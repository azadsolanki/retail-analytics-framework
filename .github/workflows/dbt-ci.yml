# =========================================================
# PR-Specific CI with Ephemeral Datasets
# =========================================================

name: dbt CI

on:
  push:
    branches:
      - main
      - 'feature/**'
  pull_request:
    branches:
      - main

# ---------------------------------------------------------
# PERMISSIONS
# ---------------------------------------------------------
# Required for the ERD job to commit and push to the repo
permissions:
  contents: write

env:
  DBT_PROJECT: data-products-441119
  DBT_PROFILE: thelook_analytics
  DBT_DATASET: ${{ github.event_name == 'pull_request' && format('dbt_ci_pr_{0}', github.event.pull_request.number) || format('dbt_ci_run_{0}', github.run_id) }}

jobs:
  # =========================================================
  # JOB 1: COMPILE
  # =========================================================
  compile:
    name: ðŸ” Compile
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
      
      - name: Create keyfile for dbt
        run: |
          printf '%s' '${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}' > /tmp/gcp-key.json
          chmod 600 /tmp/gcp-key.json
      
      - name: Create profiles.yml
        run: |
          cat << EOF > profiles.yml
          ${{ env.DBT_PROFILE }}:
            target: ci
            outputs:
              ci:
                type: bigquery
                method: service-account
                project: ${{ env.DBT_PROJECT }}
                dataset: ${{ env.DBT_DATASET }}
                threads: 4
                timeout_seconds: 300
                location: US
                keyfile: /tmp/gcp-key.json
          EOF
      
      - name: Show CI configuration
        run: |
          echo "Event type: ${{ github.event_name }}"
          echo "Dataset: ${{ env.DBT_DATASET }}"
          echo "Branch: ${{ github.ref_name }}"
      
      - name: Install dbt packages
        run: dbt deps
      
      - name: Compile dbt project
        run: dbt compile

  # =========================================================
  # JOB 2: BUILD
  # =========================================================
  build:
    name: ðŸ—ï¸ Build & Test
    runs-on: ubuntu-latest
    needs: compile
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
      
      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Create keyfile for dbt
        run: |
          printf '%s' '${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}' > /tmp/gcp-key.json
          chmod 600 /tmp/gcp-key.json
      
      - name: Create profiles.yml
        run: |
          cat << EOF > profiles.yml
          ${{ env.DBT_PROFILE }}:
            target: ci
            outputs:
              ci:
                type: bigquery
                method: service-account
                project: ${{ env.DBT_PROJECT }}
                dataset: ${{ env.DBT_DATASET }}
                threads: 4
                timeout_seconds: 300
                location: US
                keyfile: /tmp/gcp-key.json
          EOF
      
      - name: Install dbt packages
        run: dbt deps
      
      - name: Build dbt project
        run: dbt build --exclude snap_products
      
      - name: Cleanup CI dataset (push only)
        if: always() && github.event_name == 'push'
        run: |
          echo "Cleaning up dataset: ${{ env.DBT_PROJECT }}:${{ env.DBT_DATASET }}"
          bq rm -r -f ${{ env.DBT_PROJECT }}:${{ env.DBT_DATASET }} || true

  # =========================================================
  # JOB 3: ERD Generation (Only on Pull Requests)
  # =========================================================
  erd:
    name: ðŸ“Š Generate ERD
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'
    continue-on-error: true
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
      
      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Create keyfile for dbt
        run: |
          printf '%s' '${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}' > /tmp/gcp-key.json
          chmod 600 /tmp/gcp-key.json
      
      - name: Create profiles.yml
        run: |
          cat << EOF > profiles.yml
          ${{ env.DBT_PROFILE }}:
            target: ci
            outputs:
              ci:
                type: bigquery
                method: service-account
                project: ${{ env.DBT_PROJECT }}
                dataset: ${{ env.DBT_DATASET }}
                threads: 4
                timeout_seconds: 300
                location: US
                keyfile: /tmp/gcp-key.json
          EOF
      
      - name: Install dbt packages
        run: dbt deps
      
      - name: Generate dbt docs
        run: dbt docs generate
      
      - name: Install dbterd
        run: pip install dbterd

      - name: Generate ERD
        run: |
          mkdir -p docs
          dbterd run -ad target -o docs -t mermaid
          mv docs/output.md docs/erd.md

      - name: Commit ERD to repo
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add docs/erd.md
          git commit -m "Update ERD diagram [skip ci]" || echo "No changes to commit"
          git push origin ${{ github.head_ref }}
      
      - name: Cleanup CI dataset
        if: always()
        run: |
          echo "Cleaning up dataset: ${{ env.DBT_PROJECT }}:${{ env.DBT_DATASET }}"
          bq rm -r -f ${{ env.DBT_PROJECT }}:${{ env.DBT_DATASET }} || true

  # =========================================================
  # JOB 4: DOCS (Only on Pull Requests)
  # =========================================================
  docs:
    name: ðŸ“š Generate Docs
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'
    continue-on-error: true
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
      
      - name: Create keyfile for dbt
        run: |
          printf '%s' '${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}' > /tmp/gcp-key.json
          chmod 600 /tmp/gcp-key.json
      
      - name: Create profiles.yml
        run: |
          cat << EOF > profiles.yml
          ${{ env.DBT_PROFILE }}:
            target: ci
            outputs:
              ci:
                type: bigquery
                method: service-account
                project: ${{ env.DBT_PROJECT }}
                dataset: ${{ env.DBT_DATASET }}
                threads: 4
                timeout_seconds: 300
                location: US
                keyfile: /tmp/gcp-key.json
          EOF
      
      - name: Install dbt packages
        run: dbt deps
      
      - name: Generate dbt docs
        run: dbt docs generate
      
      - name: Upload docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: dbt-docs
          path: |
            target/index.html
            target/manifest.json
            target/catalog.json
          retention-days: 14