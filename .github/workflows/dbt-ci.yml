# =========================================================
# Multiple Jobs (with Security Best Practices)
# =========================================================
#
# KEY CONCEPTS:
#   1. Jobs run on SEPARATE machines (no shared files)
#   2. Jobs run in PARALLEL by default
#   3. Use "needs:" to make jobs run sequentially
#   4. Secure handling of secrets
#
# SECURITY NOTES:
#   - GitHub automatically masks secrets in logs (shows ***)
#   - We use google-github-actions/auth for proper GCP auth
#   - Keyfiles have restrictive permissions (chmod 600)
#   - Never use 'echo' with secrets (use printf instead)
#
# =========================================================

name: dbt CI

on:
  push:

# ---------------------------------------------------------
# ENVIRONMENT VARIABLES
# ---------------------------------------------------------
# Variables defined here are available to ALL jobs.
# NOTE: Never put secrets here! Use ${{ secrets.XXX }} instead.
env:
  DBT_PROJECT: data-products-441119
  DBT_DATASET: dbt_ci
  DBT_PROFILE: thelook_analytics

jobs:
  # =========================================================
  # JOB 1: COMPILE
  # =========================================================
  compile:
    name: Compile
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      # -------------------------------------------------------
      # AUTHENTICATION - SECURITY BEST PRACTICES
      # -------------------------------------------------------
      # Step 1: Use Google's official auth action
      # This sets up Application Default Credentials (ADC)
      # and is the recommended way to authenticate.
      # -------------------------------------------------------
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
      
      # -------------------------------------------------------
      # Step 2: Write keyfile for dbt
      # -------------------------------------------------------
      # dbt-bigquery needs a keyfile path in profiles.yml
      # Security measures:
      #   - printf instead of echo (doesn't add newline)
      #   - chmod 600 (only owner can read/write)
      #   - GitHub masks the secret value in logs
      # -------------------------------------------------------
      - name: Create keyfile for dbt
        run: |
          printf '%s' '${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}' > /tmp/gcp-key.json
          chmod 600 /tmp/gcp-key.json
      
      - name: Create profiles.yml
        run: |
          cat << EOF > profiles.yml
          ${{ env.DBT_PROFILE }}:
            target: ci
            outputs:
              ci:
                type: bigquery
                method: service-account
                project: ${{ env.DBT_PROJECT }}
                dataset: ${{ env.DBT_DATASET }}
                threads: 4
                timeout_seconds: 300
                location: US
                keyfile: /tmp/gcp-key.json
          EOF
      
      - name: Install dbt packages
        run: dbt deps
      
      - name: Compile dbt project
        run: dbt compile

  # =========================================================
  # JOB 2: BUILD
  # =========================================================
  build:
    name: ðŸ—ï¸ Build & Test
    runs-on: ubuntu-latest
    needs: compile
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
      
      - name: Create keyfile for dbt
        run: |
          printf '%s' '${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}' > /tmp/gcp-key.json
          chmod 600 /tmp/gcp-key.json
      
      - name: Create profiles.yml
        run: |
          cat << EOF > profiles.yml
          ${{ env.DBT_PROFILE }}:
            target: ci
            outputs:
              ci:
                type: bigquery
                method: service-account
                project: ${{ env.DBT_PROJECT }}
                dataset: ${{ env.DBT_DATASET }}
                threads: 4
                timeout_seconds: 300
                location: US
                keyfile: /tmp/gcp-key.json
          EOF
      
      - name: Install dbt packages
        run: dbt deps
      
      - name: Build dbt project
        run: dbt build

  # =========================================================
  # JOB 3: GENERATE DOCS
  # =========================================================
  docs:
    name: ðŸ“š Generate Docs
    runs-on: ubuntu-latest
    needs: compile
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
      
      - name: Create keyfile for dbt
        run: |
          printf '%s' '${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}' > /tmp/gcp-key.json
          chmod 600 /tmp/gcp-key.json
      
      - name: Create profiles.yml
        run: |
          cat << EOF > profiles.yml
          ${{ env.DBT_PROFILE }}:
            target: ci
            outputs:
              ci:
                type: bigquery
                method: service-account
                project: ${{ env.DBT_PROJECT }}
                dataset: ${{ env.DBT_DATASET }}
                threads: 4
                timeout_seconds: 300
                location: US
                keyfile: /tmp/gcp-key.json
          EOF
      
      - name: Install dbt packages
        run: dbt deps
      
      - name: Generate dbt docs
        run: dbt docs generate
      
      - name: Upload docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: dbt-docs
          path: |
            target/index.html
            target/manifest.json
            target/catalog.json
          retention-days: 14